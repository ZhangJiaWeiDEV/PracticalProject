<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>活动管理</title>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="lib/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-fileinput/5.1.2/css/fileinput.min.css" rel="stylesheet">

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap-fileinput/5.1.2/js/fileinput.js"></script>

    <link rel="stylesheet" type="text/css" href="stylesheets/theme.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/premium.css">

</head>

<body class=" theme-blue">
    
    <style type="text/css">
        #line-chart {
            height: 300px;
            width: 800px;
            margin: 0px auto;
            margin-top: 1em;
        }

        .navbar-default .navbar-brand,
        .navbar-default .navbar-brand:hover {
            color: #fff;
        }
    </style>


    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <a class="" href="index.html"><span class="navbar-brand"><span class="fa fa-paper-plane"></span>
                    活动管理管理系统</span></a></div>
    </div>


    <div class="sidebar-nav">
        <ul>
            <li><a href="#" data-target=".dashboard-menu" class="nav-header" data-toggle="collapse"><i
                        class="fa fa-fw fa-dashboard"></i> 主页<i class="fa fa-collapse"></i></a></li>
            <li>
                <ul class="dashboard-menu nav nav-list collapse in">
                    <li><a href="admin.html"><span class="fa fa-caret-right"></span>活动管理</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="content">
        <div class="header">

            <h1 class="page-title">活动管理</h1>
            <ul class="breadcrumb">
                <li><a href="admin.html">主页</a> </li>
                <li class="active">活动管理</li>
            </ul>

        </div>
        <div class="main-content">

            <div class="btn-toolbar list-toolbar">
                <button class="btn btn-primary" id="create_btn" data-toggle="modal" data-target="#createModal"><i
                        class="fa fa-plus"></i> 新增活动</button>
                <button class="btn btn-default" id="cancel_btn">取消活动</button>
                <div class="btn-group">
                </div>
            </div>
            <table class="table" id="table"></table>


            <div class="modal small fade" id="createModal" tabindex="-1" role="dialog"
                aria-labelledby="createModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width: 800px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="createModalLabel">新建活动</h3>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-sm-6 col-md-6">
                                    <div class="row">
                                        <div class="col-sm-6 col-md-4">
                                            <p>*所属党支部： </p>
                                        </div>
                                        <div class="col-sm-6 col-md-8">
                                            <input id="organization" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <br>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-4">
                                            <p>可见范围： </p>
                                        </div>
                                        <div class="col-sm-6 col-md-8">
                                            <select class="form-control">
                                                <option>全部党员</option>
                                            </select>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-4">
                                            <p>*报名名额： </p>
                                        </div>
                                        <div class="col-sm-6 col-md-8">
                                            <input id="quota" type="text" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-md-6">
                                    <form enctype="multipart/form-data" id="uploadForm">
                                        <input id="fileUpload" name="file" type="file" multiple class="file-loading">
                                    </form>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>*活动主题： </p>
                                </div>
                                <div class="col-sm-6 col-md-10">
                                    <input id="theme" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>活动摘要： </p>
                                </div>
                                <div class="col-sm-6 col-md-10">
                                    <input id="summary" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>*活动地址： </p>
                                </div>
                                <div class="col-sm-6 col-md-10">
                                    <input id="location" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>*活动开始时间： </p>
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <input id="startTime" type="text" class="form-control">
                                </div>
                                <div class="col-sm-6 col-md-2">
                                    <p>*活动结束时间： </p>
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <input id="endTime" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>*报名开始时间： </p>
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <input id="registerStartTime" type="text" class="form-control">
                                </div>
                                <div class="col-sm-6 col-md-2">
                                    <p>*报名结束时间： </p>
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <input id="registerEndTime" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>活动要求： </p>
                                </div>
                                <div class="col-sm-6 col-md-10">
                                    <input id="demand" type="text" class="form-control">
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6 col-md-2">
                                    <p>*活动描述： </p>
                                </div>
                                <div class="col-sm-6 col-md-10">
                                    <textarea id="description" class="form-control"
                                        style="overflow: scroll;overflow-x: hidden;"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">取消</button>
                            <button class="btn btn-danger" data-dismiss="modal" onclick="save()">保存</button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal small fade" id="registerModal" tabindex="-1" role="dialog"
                aria-labelledby="registerModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width: 800px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="registerModalLabel">报名列表</h3>
                        </div>
                        <div class="modal-body">
                            <table class="table" id="registerTable"></table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal small fade" id="commentModal" tabindex="-1" role="dialog"
                aria-labelledby="commentModalLabel" aria-hidden="true">
                <div class="modal-dialog" style="width: 800px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="commentModalLabel">评论列表</h3>
                        </div>
                        <div class="modal-body">
                            <table class="table" id="commentTable"></table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal small fade" id="likeModal" tabindex="-1" role="dialog" aria-labelledby="likeModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" style="width: 800px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="likeModalLabel">点赞列表</h3>
                        </div>
                        <div class="modal-body">
                            <table class="table" id="likeTable"></table>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                var serverUrl = "http://127.0.0.1:8882/";
                var selectIndex = -1;              //当前所点击行的序号

                $("#registerTable").bootstrapTable({
                    uniqueId: "id",      //唯一主键
                    pagination: true,       //是否分页
                    pageSize: 10,           //每页的记录行数
                    search: false,           //是否显示搜索框
                    toolbar: "#toolbar",     //工具栏容器，左上方
                    columns: [
                        {
                            field: "id",
                            title: "序号",
                            align: "center",
                            edit: false,
                            formatter: function (value, row, index) {
                                return row.index = index + 1;
                            }
                        },
                        {
                            field: "name",
                            title: "姓名",
                            align: "center",
                        }, {
                            field: "organization",
                            title: "党支部",
                            align: "center",
                        }, {
                            field: "registerTime",
                            title: "报名时间",
                            align: "center",
                        }],
                    onClickRow: function (row, $element, field) {        //鼠标点击表格记录，记录所在行变色
                        $("tr").css("background-color", "");
                        $($element).css("background-color", "#f8f8f8");
                    },
                });

                $("#commentTable").bootstrapTable({
                    uniqueId: "id",      //唯一主键
                    pagination: true,       //是否分页
                    pageSize: 10,           //每页的记录行数
                    search: false,           //是否显示搜索框
                    toolbar: "#toolbar",     //工具栏容器，左上方
                    columns: [
                        {
                            field: "id",
                            title: "序号",
                            align: "center",
                            edit: false,
                            formatter: function (value, row, index) {
                                return row.index = index + 1;
                            }
                        }, {
                            field: "userName",
                            title: "评论者名称",
                            align: "center"
                        }, {
                            field: "content",
                            title: "内容",
                            align: "center"
                        }, {
                            field: "commentTime",
                            title: "评论时间",
                            align: "center",
                        }],
                    onClickRow: function (row, $element, field) {        //鼠标点击表格记录，记录所在行变色
                        $("tr").css("background-color", "");
                        $($element).css("background-color", "#f8f8f8");
                    },
                });

                $("#likeTable").bootstrapTable({
                    uniqueId: "id",      //唯一主键
                    pagination: true,       //是否分页
                    pageSize: 10,           //每页的记录行数
                    search: false,           //是否显示搜索框
                    toolbar: "#toolbar",     //工具栏容器，左上方
                    columns: [
                        {
                            field: "id",
                            title: "序号",
                            align: "center",
                            edit: false,
                            formatter: function (value, row, index) {
                                return row.index = index + 1;
                            }
                        }, {
                            field: "userName",
                            title: "点赞者名称",
                            align: "center"
                        }, {
                            field: "likeTime",
                            title: "点赞时间",
                            align: "center",
                        }],
                    onClickRow: function (row, $element, field) {        //鼠标点击表格记录，记录所在行变色
                        $("tr").css("background-color", "");
                        $($element).css("background-color", "#f8f8f8");
                    },
                });

                $("#table").bootstrapTable({
                    url: serverUrl + "getAllActivity",       //发送get请求的url地址
                    uniqueId: "id",      //唯一主键
                    pagination: true,       //是否分页
                    pageSize: 10,           //每页的记录行数
                    search: true,           //是否显示搜索框
                    toolbar: "#toolbar",     //工具栏容器，左上方
                    columns: [
                        {
                            field: "id",
                            title: "序号",
                            align: "center",
                            edit: false,
                            formatter: function (value, row, index) {
                                return row.index = index + 1;
                            }
                        },
                        {
                            field: "organization",
                            title: "所属党支部",
                            align: "center",
                        }, {
                            field: "theme",
                            title: "活动主题",
                            align: "center",
                        }, {
                            field: "registerStartTime",
                            title: "报名开始时间",
                            align: "center",
                        }, {
                            field: "registerEndTime",
                            title: "报名结束时间",
                            align: "center",
                        }, {
                            field: "status",
                            title: "状态",
                            align: "center",
                            formatter: function (value, row, index) {
                                if (value == 1)
                                    return "活动取消";
                                return activityStatus(row['registerEndTime'], row['endTime']);
                            },
                        }, {
                            field: "registerNumber",
                            title: "已报名人数",
                            align: "center",
                            formatter: function (value, row, index) {
                                registerId = row['id'];
                                return "<a href='' data-toggle='modal' data-target='#registerModal'>" + value + "</a>";
                            }
                        }, {
                            field: "commentNumber",
                            title: "评论数",
                            align: "center",
                            formatter: function (value, row, index) {
                                return "<a href='' data-toggle='modal' data-target='#commentModal'>" + value + "</a>";
                            }
                        }, {
                            field: "likeNumber",
                            title: "点赞数",
                            align: "center",
                            formatter: function (value, row, index) {
                                return "<a href='' data-toggle='modal' data-target='#likeModal'>" + value + "</a>";
                            }
                        }],
                    onClickRow: function (row, $element, field) {        //鼠标点击表格记录，记录所在行变色
                        selectIndex = row.id;
                        $('#registerTable').bootstrapTable('refresh', { url: serverUrl + "getRegisterByActivity/" + selectIndex });
                        $('#commentTable').bootstrapTable('refresh', { url: serverUrl + "getCommentByActivity/" + selectIndex });
                        $('#likeTable').bootstrapTable('refresh', { url: serverUrl + "getLikeByActivity/" + selectIndex });
                        $("tr").css("background-color", "");
                        $($element).css("background-color", "#f8f8f8");
                    },
                });

                function save() {
                    var jsonData = {
                        organization: document.getElementById("organization").value,
                        theme: document.getElementById("theme").value,
                        summary: document.getElementById("summary").value,
                        startTime: document.getElementById("startTime").value,
                        endTime: document.getElementById("endTime").value,
                        location: document.getElementById("location").value,
                        registerStartTime: document.getElementById("registerStartTime").value,
                        registerEndTime: document.getElementById("registerEndTime").value,
                        quota: document.getElementById("quota").value,
                        description: document.getElementById("description").value,
                        demand: document.getElementById("demand").value
                    }
                    if(jsonData.organization == "" || jsonData.quota == "" || jsonData.theme == "" || jsonData.location == ""
                        || jsonData.startTime == "" || jsonData.endTime == "" || jsonData.registerStartTime == ""
                        || jsonData.registerEndTime == "" || jsonData.description == ""){
                            alert("*号信息必填");
                            return;
                        }
                    if(getJSON("POST", serverUrl + "insertActivity", JSON.stringify(jsonData)) == 301){
                        alert("活动主题已存在");
                    }
                    else{
                        $('#table').bootstrapTable('refresh', { pageSize: 10 });
                    }
                }

                $("#cancel_btn").click(function () {
                    if (selectIndex < 0) {
                        alert("请选择活动");
                    }
                    else if (confirm("确认取消该活动?")) {
                        var data = $('#table').bootstrapTable('getRowByUniqueId', selectIndex);
                        if (data.status == 1) {
                            alert("该活动已被取消");
                            return;
                        } else if(activityStatus(data.registerEndTime, endTime) == "活动结束"){
                            alert("该活动已结束，无法取消");
                            return;
                        }
                        getJSON("PUT", serverUrl + "cancel/" + data.id);
                        $('#table').bootstrapTable('refresh', { pageSize: 10 });
                    }
                })

                function getJSON(type, url, jsonData) {
                    var xmlhttp;
                    if (window.XMLHttpRequest) {
                        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
                        xmlhttp = new XMLHttpRequest();
                    }
                    else {
                        // IE6, IE5 浏览器执行代码
                        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                    xmlhttp.onreadystatechange = function () {
                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                            return xmlhttp.responseText;
                        }
                    }
                    xmlhttp.open(type, url, false);
                    xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    xmlhttp.send(jsonData);
                    if (xmlhttp.responseText != null) {
                        return JSON.parse(xmlhttp.responseText);
                    }
                }

            </script>

        </div>
    </div>

    <script>
        function activityStatus(registerEndTime, endTime) {
            var now = new Date();
            var d1 = new Date(Date.parse(registerEndTime));
            var d2 = new Date(Date.parse(endTime));
            if (now <= d1)
                return "报名中";
            else if (now <= d2)
                return "活动进行中";
            else
                return "活动结束";
        }

        $("#fileUpload").fileinput({
            allowedFileExtensions: ['img', 'jpg'],
            uploadAsync: true,
            maxFileCount: 1,
            uploadExtraData: { state: "0" }
        });

    </script>

</body>

</html>