<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>个人页面</title>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="stylesheet" href="lib/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.css" rel="stylesheet">

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <link rel="stylesheet" type="text/css" href="stylesheets/theme.css">
    <link rel="stylesheet" type="text/css" href="stylesheets/premium.css">

</head>

<body class=" theme-blue">
    <style type="text/css">
        #line-chart {
            height: 300px;
            width: 800px;
            margin: 0px auto;
            margin-top: 1em;
        }

        .navbar-default .navbar-brand,
        .navbar-default .navbar-brand:hover {
            color: #fff;
        }
    </style>

    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
            <a class="" href="index.html"><span class="navbar-brand"><span class="fa fa-paper-plane"></span>
                    活动管理管理系统</span></a></div>
        <div class="navbar-collapse collapse" style="height: 1px;">
            <ul id="main-menu" class="nav navbar-nav navbar-right">
                <li class="dropdown hidden-xs">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="a">
                        <span class="glyphicon glyphicon-user padding-right-small"
                            style="position:relative;top: 3px;"></span>
                        <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="index.html">个人界面</a></li>
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="login.html">退出登录</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <div class="sidebar-nav">
        <ul>
            <li><a href="#" data-target=".dashboard-menu" class="nav-header" data-toggle="collapse"><i
                        class="fa fa-fw fa-dashboard"></i> 主页<i class="fa fa-collapse"></i></a></li>
            <li>
                <ul class="dashboard-menu nav nav-list collapse in">
                    <li><a href="index.html"><span class="fa fa-caret-right"></span>个人页面</a></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="content">
        <div class="header">
            <div class="stats">
                <p class="stat"><span class="label label-info">1</span> 报名中</p>
                <p class="stat"><span class="label label-success">6</span> 全部活动</p>
                <p class="stat"><span class="label label-danger">3</span> 我的活动</p>
            </div>

            <h1 class="page-title">报名中</h1>
            <ul class="breadcrumb">
                <li><a href="index.html">报名中</a> </li>
                <li class="active"><a href="allActivity.html">全部活动</a></li>
                <li class="active"><a href="myActivity.html">我的活动</a></li>
            </ul>

        </div>
        <div class="main-content">
            <div class="row">
                <div class="col-sm-6 col-md-4"></div>
                <div class="col-sm-6 col-md-4">
                    <table class="table table-bordered">
                        <tbody id="table">

                        </tbody>
                    </table>
                    <button type="button" class="btn btn-primary pull-right" id="btn">加载更多</button>
                </div>
                <div class="col-sm-6 col-md-4"></div>

            </div>
        </div>
    </div>

    <div class="modal small fade" id="activityModal" tabindex="-1" role="dialog" aria-labelledby="activityModalLabel"
        aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" style="width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="activityModalLabel">活动详情</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>活动主题： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <p id="themeModal"></p>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>活动描述： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <p id="descriptionModal"></p>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>活动地点： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <p id="locationModal"></p>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>活动时间： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <div class="row">
                                <div class="col-sm-6 col-md-3">
                                    <p id="startTimeModal"></p>
                                </div>
                                <div class="col-sm-6 col-md-1">
                                    <p>~</p>
                                </div>
                                <div class="col-sm-6 col-md-8">
                                    <p id="endTimeModal"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>报名时间： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <div class="row">
                                <div class="col-sm-6 col-md-3">
                                    <p id="startRegisterModal"></p>
                                </div>
                                <div class="col-sm-6 col-md-1">
                                    <p>~</p>
                                </div>
                                <div class="col-sm-6 col-md-8">
                                    <p id="endRegisterModal"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-sm-6 col-md-2">
                            <p>报名名额： </p>
                        </div>
                        <div class="col-sm-6 col-md-10">
                            <p id="quotaModal"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" id="like_btn">我要点赞</button>
                    <button class="btn btn-danger" id="register_btn">我要报名</button>
                </div>
                <div class="panel panel-default">
                    <a href="#page-stats" class="panel-heading" data-toggle="collapse">消息区</a>
                    <div id="page-stats" class="panel-collapse panel-body collapse in">
                        <a href="#page-stats1" id="registerMemberNumber" class="panel-heading"
                            data-toggle="collapse"></a>
                        <div id="page-stats1" class="panel-collapse panel-body collapse in">
                            <p id="registerMember"></p>
                        </div>
                        <a href="#page-stats2" id="likeMemberNumber" class="panel-heading" data-toggle="collapse"></a>
                        <div id="page-stats2" class="panel-collapse panel-body collapse in">
                            <table class="table table-bordered">
                                <tbody id="likeTable"></tbody>
                            </table>
                        </div>
                        <a href="#page-stats3" id="commentMemberNumber" class="panel-heading"
                            data-toggle="collapse"></a>
                        <div id="page-stats3" class="panel-collapse panel-body collapse in">
                            <table class="table table-bordered">
                                <tbody id="commentTable"></tbody>
                            </table>

                            <form role="form">
                                <div class="form-group">
                                    <label for="name">我也要评论</label>
                                    <input type="text" id="commentInput" class="form-control" placeholder="写下您的评论....">
                                    <button class="btn btn-danger" id="comment_btn">发布</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        if ($.cookie("account") == "") {
            alert("请登录");
            location.replace("login.html");
        }
        //获取的活动列表
        var activityList;
        //当前点击行的活动
        var activity;
        //用户账号
        var account;
        //是否点赞当前活动
        var likeStatus;
        //是否报名当前活动
        var registerStatus;
        //是否评论当前活动
        var commentStatus;
        //报名列表
        var registerMember = new Array();
        //点赞列表
        var likeMember = new Array();
        //评论列表
        var commentMember = new Array();
        //当前显示的活动列表行数
        var row = 0;

        activityList = requestJSON("GET", "http://127.0.0.1:8880/getAllActivity");
        account = requestJSON("POST", "http://127.0.0.1:8880/getUserByTelNumber/" + $.cookie("account"));

        var user_name = account.name;
        document.getElementById("a").innerHTML = "<span class='glyphicon glyphicon-user padding-right-small' style='position:relative;top: 3px;''></span>" + user_name + " <i class='fa fa-caret-down'></i>";

        var registerActivity = new Array();
        for (i = 0; i < activityList.length; i++) {
            if (activityList[i].status == 0 && activityStatus(activityList[i].registerEndTime, activityList[i].endTime) == "报名中")
                registerActivity.push(activityList[i]);
        }

        for (; row < 5 && row < registerActivity.length; row++) {
            var div_child = getActivityTrHTML(registerActivity[row]);
            $("#table").append(div_child);
        }

        $("#btn").bind("click", function () {
            if (row < registerActivity.length) {
                var div_child = getActivityTrHTML(registerActivity[row]);
                $("#table").append(div_child);
                row++;
            } else {
                alert("没有更多了。。。。")
            }
        });

        $("#like_btn").bind("click", function () {
            var date = new Date();
            var jsonData = {
                userId: account.id,
                userName: account.name,
                activityId: activity.id,
                likeTime: date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes()
            }
            if (likeStatus == true) {
                requestJSON("DELETE", "http://127.0.0.1:8880/deleteLike", JSON.stringify(jsonData));
                likeStatus = false;
                document.getElementById("like_btn").innerText = "我要点赞";
            } else if (likeStatus == false) {
                requestJSON("POST", "http://127.0.0.1:8880/like", JSON.stringify(jsonData));
                likeStatus = true;
                document.getElementById("like_btn").innerText = "取消点赞";
            }
        });

        $("#register_btn").bind("click", function () {
            var date = new Date();
            var jsonData = {
                userId: account.id,
                activityId: activity.id,
                name: account.name,
                organization: account.organization,
                registerTime: date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes()
            }
            if (registerStatus == true) {
                requestJSON("DELETE", "http://127.0.0.1:8880/cancelRegister", JSON.stringify(jsonData));
                registerStatus = false;
                document.getElementById("register_btn").innerText = "我要报名";
            } else if (registerStatus == false) {
                requestJSON("POST", "http://127.0.0.1:8880/register", JSON.stringify(jsonData));
                registerStatus = true;
                document.getElementById("register_btn").innerText = "取消报名";
            }
        });

        $("#comment_btn").bind("click", function () {
            var date = new Date();
            var jsonData = {
                userId: account.id,
                userName: account.name,
                activityId: activity.id,
                commentTime: date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes(),
                content: document.getElementById("commentInput").value
            }
            commentStatus = requestJSON("POST", "http://127.0.0.1:8880/comment", JSON.stringify(jsonData));
            document.getElementById("commentInput").value = "";
        });

        function activityStatus(registerEndTime, endTime) {
            var now = new Date();
            var d1 = new Date(Date.parse(registerEndTime));
            var d2 = new Date(Date.parse(endTime));
            if (now <= d1)
                return "报名中";
            else if (now > d1 && now <= d2)
                return "活动进行中";
            else if (now > d2)
                return "活动结束";
        }

        function Click(tr) {

            var cells = tr.cells;
            var string = "";
            for (i = 0; i < cells[1].innerText.length; i++) {
                if (cells[1].innerText[i] != "\n")
                    string += cells[1].innerText[i]
                else
                    break;
            }
            activity = requestJSON("GET", "http://127.0.0.1:8880/getActivity/" + string);
            document.getElementById("themeModal").innerText = activity.theme;
            document.getElementById("descriptionModal").innerText = activity.description;
            document.getElementById("locationModal").innerText = activity.location;
            document.getElementById("startTimeModal").innerText = activity.startTime;
            document.getElementById("endTimeModal").innerText = activity.endTime;
            document.getElementById("startRegisterModal").innerText = activity.registerStartTime;
            document.getElementById("endRegisterModal").innerText = activity.registerEndTime;
            document.getElementById("quotaModal").innerText = activity.quota;

            var jsonData = {
                userId: account.id,
                activityId: activity.id
            }

            likeStatus = requestJSON("POST", "http://127.0.0.1:8880/isLikeExit", JSON.stringify(jsonData));
            if (likeStatus == true)
                document.getElementById("like_btn").innerText = "取消点赞";
            registerStatus = requestJSON("POST", "http://127.0.0.1:8880/isRegisterExit", JSON.stringify(jsonData));
            if (registerStatus == true)
                document.getElementById("register_btn").innerText = "取消报名";
            else if (activity.registerJSON == activity.quota && new Date(registerEndTime) <= new Date()) {
                document.getElementById("register_btn").innerText = "报名结束";
            }

            registerMember = requestJSON("GET", "http://127.0.0.1:8880/getRegisterByActivity/" + activity.id);
            document.getElementById("registerMemberNumber").innerText = "已报名人员(" + registerMember.length + "):";
            document.getElementById("registerMember").innerText = "";
            for (i = 0; i < registerMember.length; i++) {
                document.getElementById("registerMember").innerText += (registerMember[i].name + " 、 ");
            }

            likeMember = requestJSON("GET", "http://127.0.0.1:8880/getLikeByActivity/" + activity.id);
            document.getElementById("likeMemberNumber").innerText = "点赞数(" + likeMember.length + "):";
            document.getElementById("likeTable").innerHTML = "";
            for (i = 0; i < likeMember.length; i++) {
                var div_child = getLikeTrHTML(likeMember[i]);
                $("#likeTable").append(div_child);
            }

            commentMember = requestJSON("GET", "http://127.0.0.1:8880/getCommentByActivity/" + activity.id);
            document.getElementById("commentMemberNumber").innerText = "评论数(" + commentMember.length + "):";
            document.getElementById("commentTable").innerHTML = "";
            for (i = 0; i < commentMember.length; i++) {
                var div_child = getCommentTrHTML(commentMember[i]);
                $("#commentTable").append(div_child);
            }
        }

        function getActivityTrHTML(activity) {
            return '<tr onclick="Click(this)">' +
                '   <td>' +
                '       <p class="info">' + activityStatus(activity.registerEndTime, activity.endTime) + '</p>' +
                '   </td>' +
                '   <td>' +
                '       <a href="#" data-toggle="modal" data-target="#activityModal">' +
                '           <p class="title">' + activity.theme + '</p>' +
                '       </a>' +
                '       <a href="#" data-toggle="modal" data-target="#activityModal">' +
                '           <p>摘要：' + activity.summary + '</p>' +
                '       </a>' +
                '       <a href="#" data-toggle="modal" data-target="#activityModal">' +
                '           <p>报名时间：' + activity.registerStartTime + '~' + activity.registerEndTime + '</p>' +
                '       </a>' +
                '   </td>' +
                '   <td>' +
                '       <a href="#" data-toggle="modal" data-target="#activityModal">' +
                '           <p class="text-danger h3 pull-right" style="margin-top: 12px;">' + activity.registerNumber + '/' + activity.quota + '</p>' +
                '       </a>' +
                '   </td>' +
                '</tr>';
        }

        function getLikeTrHTML(like) {
            return '<tr>' +
                '   <td>' +
                '       <p class="info"></p>' +
                '   </td>' +
                '   <td>' +
                '       <p class="title">' + like.userName + '</p>' +
                '       <p>' + like.likeTime + '</p>' +
                '   </td>' +
                '</tr>';
        }

        function getCommentTrHTML(comment) {
            return '<tr>' +
                '   <td>' +
                '       <p class="info"></p>' +
                '   </td>' +
                '   <td>' +
                '       <p class="title">' + comment.userName + '</p>' +
                '       <p>' + comment.commentTime + '</p>' +
                '   </td>' +
                '   <td>' +
                '       <p>' + comment.content + '</p>' +
                '   </td>' +
                '</tr>';
        }

        function requestJSON(type, url, jsonData) {
            var xmlhttp;
            if (window.XMLHttpRequest) {
                //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
                xmlhttp = new XMLHttpRequest();
            }
            else {
                // IE6, IE5 浏览器执行代码
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    return xmlhttp.responseText;
                }
            }
            xmlhttp.open(type, url, false);
            xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xmlhttp.send(jsonData);
            if (xmlhttp.responseText != null) {
                return JSON.parse(xmlhttp.responseText);
            }
        }   
    </script>

</body>

</html>